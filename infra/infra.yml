AWSTemplateFormatVersion: "2010-09-09"
Description: "WalterBackend Infrastructure"

##################
### PARAMETERS ###
##################

Parameters:

  AppEnvironment:
    Type: String
    Description: The environment of the WalterBackend stack
    Default: dev
    AllowedValues:
      - dev
      - preprod
      - prod

  # TODO: Get rid of this Lambda layer after migrating all Lambdas to containers
  WalterBackendLambdaLayerVersion:
    Type: String
    Description: The version of the Lambda layer that includes the Python dependencies required by WalterBackend
    Default: 2 # set the default to the latest WalterBackendLambdaPythonDependencies version

  WalterAPIImageURI:
    Type: String
    Description: The image URI of the WalterAPI container
    Default: 010526272437.dkr.ecr.us-east-1.amazonaws.com/walter/api:latest

  WalterAPITimeoutSeconds:
    Type: Number
    Description: The timeout in seconds of each API included in WalterAPI
    Default: 30

  WalterAPILambdaArchitecture:
    Type: String
    Description: The desired architecture of the Lambda environments that serve the WalterAPI endpoints
    Default: arm64
    AllowedValues:
      - arm64
      - x86_64

  WalterAPILambdaMemorySizeMegabytes:
    Type: Number
    Description: The memory in Megabytes (MB) allocated to the Lambda environments that serve the WalterAPI endpoints
    Default: 256

  WalterAPILambdaProvisionedConcurrencyCount:
    Type: Number
    Description: The number of Lambdas to keep warm for provisioned concurrency to improve WalterAPI latency.
    Default: 1

  WalterAPILogLevel:
    Type: String
    Description: The logging level of WalterAPI.
    Default: DEBUG
    AllowedValues:
      - DEBUG
      - INFO

#################
### RESOURCES ###
#################

Resources:

  ###################
  ### API GATEWAY ###
  ###################

  WalterAPIGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub "WalterAPI-${AppEnvironment}"
      Description: "API Gateway for WalterAPI"

  WalterAPIAuthResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: auth

  WalterAPIAuthUserPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIAuthUser.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIAuthUserMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPIAuthResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIAuthUser.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIAuthUserCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIAuthResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIUsers:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: users

  WalterAPICreateUserPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPICreateUser.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPICreateUserMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPIUsers
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPICreateUser.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPICreateUserCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIUsers
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIGetUserMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIUsers
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIGetUser.Arn}:release/invocations" # provisioned concurrency -> release alias
      MethodResponses:
        - StatusCode: 200

  WalterAPIGetUserPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIGetUser.Arn}:release" # provisioned concurrency -> release alias
      Principal: apigateway.amazonaws.com

  WalterAPIUpdateUserMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: PUT
      ResourceId: !Ref WalterAPIUsers
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIUpdateUser.Arn}:release/invocations" # provisioned concurrency -> release alias
      MethodResponses:
        - StatusCode: 200

  WalterAPIUpdateUserPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIUpdateUser.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIStocks:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: stocks

  WalterAPIGetStockMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIStocks
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIGetStock.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIGetStockPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIGetStock.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIStockStatistics:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref WalterAPIStocks
      RestApiId: !Ref WalterAPIGateway
      PathPart: statistics

  WalterAPIGetStatisticsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIGetStatistics.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIGetStatisticsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIStockStatistics
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIGetStatistics.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIGetStatisticsCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIStockStatistics
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'DELETE,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIAddStockMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPIStocks
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIAddStock.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIAddStockCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIStocks
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'DELETE,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIAddStockPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIAddStock.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIDeleteStockMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: DELETE
      ResourceId: !Ref WalterAPIStocks
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIDeleteStock.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIDeleteStockPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIDeleteStock.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIPrices:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: prices

  WalterAPIGetPricesMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIPrices
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIGetPrices.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIGetPricesPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIGetPrices.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPINews:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: news

  WalterAPIGetNewsSummaryPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIGetNewsSummary.Arn}:release"
      Principal: apigateway.amazonaws.com


  WalterAPIGetNewsSummaryMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPINews
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIGetNewsSummary.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIGetNewsSummaryCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPINews
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIGetPortfolioResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: portfolios

  WalterAPIGetPortfolioMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIGetPortfolioResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIGetPortfolio.Arn}:release/invocations" # provisioned concurrency -> release alias
      MethodResponses:
        - StatusCode: 200

  WalterAPIGetPortfolioCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIGetPortfolioResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Max-Age: "'86400'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
            method.response.header.Access-Control-Max-Age: false

  WalterAPIGetPortfolioPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIGetPortfolio.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIGetUserNewsletterResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref WalterAPINewsletters
      RestApiId: !Ref WalterAPIGateway
      PathPart: archive

  WalterAPIGetNewsletterPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIGetNewsletter.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIGetNewsletterMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIGetUserNewsletterResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIGetNewsletter.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIGetNewsletterCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIGetUserNewsletterResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,DELETE,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIGetNewslettersPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIGetNewsletters.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIGetNewslettersMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPINewsletters
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIGetNewsletters.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPISendNewsletterPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WalterAPISendNewsletter
      Principal: apigateway.amazonaws.com

  WalterAPINewsletters:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: newsletters

  WalterAPISendNewsletterMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPINewsletters
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPISendNewsletter.Arn}/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPISendNewsletterCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPINewsletters
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPISendVerifyEmailPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WalterAPISendVerifyEmail
      Principal: apigateway.amazonaws.com

  WalterAPIVerify:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: verify

  WalterAPISendVerifyEmailMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIVerify
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPISendVerifyEmail.Arn}/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPISendVerifyEmailCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIVerify
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIVerifyEmailPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WalterAPIVerifyEmail
      Principal: apigateway.amazonaws.com

  WalterAPIVerifyEmailMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPIVerify
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIVerifyEmail.Arn}/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPISendChangePasswordEmailPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WalterAPISendChangePasswordEmail
      Principal: apigateway.amazonaws.com

  WalterAPIPasswords:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: passwords

  WalterAPISendChangePasswordEmailMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIPasswords
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPISendChangePasswordEmail.Arn}/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIPasswordsCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIPasswords
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIUpdatePasswordPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIUpdatePassword.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIUpdatePasswordMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPIPasswords
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIUpdatePassword.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPISubscribePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WalterAPISubscribe
      Principal: apigateway.amazonaws.com

  WalterAPISubscribeResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: subscribe

  WalterAPISubscribeMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPISubscribeResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPISubscribe.Arn}/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPISubscribeCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPISubscribeResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIUnsubscribePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WalterAPIUnsubscribe
      Principal: apigateway.amazonaws.com

  WalterAPIUnsubscribeResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: unsubscribe

  WalterAPIUnsubscribeMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIUnsubscribeResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIUnsubscribe.Arn}/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIUnsubscribeCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIUnsubscribeResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIPurchaseNewsletterSubscriptionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WalterAPIPurchaseNewsletterSubscription
      Principal: apigateway.amazonaws.com

  WalterAPIPurchaseNewsletterSubscriptionResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: purchase

  WalterAPIPurchaseNewsletterSubscriptionMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIPurchaseNewsletterSubscriptionResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIPurchaseNewsletterSubscription.Arn}/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIPurchaseNewsletterSubscriptionCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIPurchaseNewsletterSubscriptionResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIVerifyPurchaseNewsletterSubscriptionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WalterAPIVerifyPurchaseNewsletterSubscription
      Principal: apigateway.amazonaws.com

  WalterAPIVerifyPurchaseNewsletterSubscriptionResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref WalterAPIPurchaseNewsletterSubscriptionResource
      RestApiId: !Ref WalterAPIGateway
      PathPart: verify

  WalterAPIVerifyPurchaseNewsletterSubscriptionMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPIVerifyPurchaseNewsletterSubscriptionResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIVerifyPurchaseNewsletterSubscription.Arn}/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIVerifyPurchaseNewsletterSubscriptionCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIVerifyPurchaseNewsletterSubscriptionResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,DELETE,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPICashAccountsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: cash-accounts

  WalterAPIGetCashAccountsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIGetCashAccounts.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIGetCashAccountsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPICashAccountsResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIGetCashAccounts.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIUpdateCashAccountPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIUpdateCashAccount.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIUpdateCashAccountMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: PUT
      ResourceId: !Ref WalterAPICashAccountsResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIUpdateCashAccount.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIDeleteCashAccountPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIDeleteCashAccount.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIDeleteCashAccountMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: DELETE
      ResourceId: !Ref WalterAPICashAccountsResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIDeleteCashAccount.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPICreateCashAccountPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPICreateCashAccount.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPICreateCashAccountMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPICashAccountsResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPICreateCashAccount.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPICashAccountsCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPICashAccountsResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,DELETE,POST,PUT,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPITransactionsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: transactions

  WalterAPIGetTransactionsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIGetTransactions.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIGetTransactionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPITransactionsResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIGetTransactions.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIAddTransactionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIAddTransaction.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIAddTransactionMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPITransactionsResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIAddTransaction.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIEditTransactionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIEditTransaction.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIEditTransactionMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: PUT
      ResourceId: !Ref WalterAPITransactionsResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIEditTransaction.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIDeleteTransactionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIDeleteTransaction.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIDeleteTransactionMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: DELETE
      ResourceId: !Ref WalterAPITransactionsResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIDeleteTransaction.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPITransactionsCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPITransactionsResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,DELETE,POST,PUT,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIPlaidResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt WalterAPIGateway.RootResourceId
      RestApiId: !Ref WalterAPIGateway
      PathPart: plaid

  WalterAPICreateLinkTokenResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref WalterAPIPlaidResource
      RestApiId: !Ref WalterAPIGateway
      PathPart: create-link-token

  WalterAPICreateLinkTokenPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPICreateLinkToken.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPICreateLinkTokenMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPICreateLinkTokenResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPICreateLinkToken.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPICreateLinkTokenCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPICreateLinkTokenResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,DELETE,POST,PUT,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPIExchangePublicTokenResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref WalterAPIPlaidResource
      RestApiId: !Ref WalterAPIGateway
      PathPart: exchange-public-token

  WalterAPIExchangePublicTokenPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPIExchangePublicToken.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPIExchangePublicTokenMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPIExchangePublicTokenResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPIExchangePublicToken.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPIExchangePublicTokenCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPIExchangePublicTokenResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,DELETE,POST,PUT,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPISyncTransactionsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref WalterAPIPlaidResource
      RestApiId: !Ref WalterAPIGateway
      PathPart: sync-transactions

  WalterAPISyncTransactionsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPISyncTransactions.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPISyncTransactionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId: !Ref WalterAPISyncTransactionsResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPISyncTransactions.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPISyncTransactionsCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPISyncTransactionsResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,DELETE,POST,PUT,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  WalterAPISearchStocksPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WalterAPISearchStocks.Arn}:release"
      Principal: apigateway.amazonaws.com

  WalterAPISearchStocksResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref WalterAPIStocks
      RestApiId: !Ref WalterAPIGateway
      PathPart: search

  WalterAPISearchStocksMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId: !Ref WalterAPISearchStocksResource
      RestApiId: !Ref WalterAPIGateway
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WalterAPISearchStocks.Arn}:release/invocations"
      MethodResponses:
        - StatusCode: 200

  WalterAPISearchStocksCORSMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref WalterAPIGateway
      ResourceId: !Ref WalterAPISearchStocksResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,DELETE,POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  ##############
  ### LAMBDA ###
  ##############

  # NOTE: Do not add provisioned concurrency to AuthUser release alias. Authentication is intentionally slow to
  # impede brute force attacks. The additional cost in latency from the occasional cold-start is fine and slightly ideal.
  WalterAPIAuthUserAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIAuthUser
      FunctionVersion: 3
      Name: "release"

  # NOTE: Do not add provisioned concurrency to AuthUser API to reduce latency, authentication is intentionally slow
  # to prevent brute force attacks
  WalterAPIAuthUser:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-AuthUser-${AppEnvironment}"
      Description: !Sub "WalterAPI: AuthUser - authenticate a user (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.auth_user_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPICreateUserAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPICreateUser
      FunctionVersion: 34
      Name: "release"

  WalterAPICreateUser:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-CreateUser-${AppEnvironment}"
      Description: !Sub "WalterAPI: CreateUser - create user and add to database (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.create_user_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIGetUserAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIGetUser
      FunctionVersion: 39
      Name: "release"

  WalterAPIGetUser:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-GetUser-${AppEnvironment}"
      Description: !Sub "WalterAPI: GetUser - Get user from WalterDB with JWT (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.get_user_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIUpdateUserAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIUpdateUser
      FunctionVersion: 8
      Name: "release"

  WalterAPIUpdateUser:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-UpdateUser-${AppEnvironment}"
      Description: !Sub "WalterAPI: UpdateUser - Update user details stored in WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.update_user_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIGetStockAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIGetStock
      FunctionVersion: 14
      Name: "release"
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref WalterAPILambdaProvisionedConcurrencyCount

  WalterAPIGetStock:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-GetStock-${AppEnvironment}"
      Description: !Sub "WalterAPI: GetStock - Get stock and its details from WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.get_stock_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIGetStatisticsAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIGetStatistics
      FunctionVersion: 3
      Name: "release"

  WalterAPIGetStatistics:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-GetStatistics-${AppEnvironment}"
      Description: !Sub "WalterAPI: GetStatistics - Get statistics about the given stock (${AppEnvironment})"
      Handler: walter.get_statistics_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIAddStockAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIAddStock
      FunctionVersion: 73
      Name: "release"

  WalterAPIAddStock:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-AddStock-${AppEnvironment}"
      Description: !Sub "WalterAPI: AddStock - Add stock and number of shares to user portfolio (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.add_stock_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIDeleteStockAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIDeleteStock
      FunctionVersion: 70
      Name: "release"

  WalterAPIDeleteStock:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-DeleteStock-${AppEnvironment}"
      Description: !Sub "WalterAPI: DeleteStock - Delete a stock from user portfolio (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.delete_stock_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIGetPricesAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIGetPrices
      FunctionVersion: 18
      Name: "release"
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref WalterAPILambdaProvisionedConcurrencyCount

  WalterAPIGetPrices:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-GetPrices-${AppEnvironment}"
      Description: !Sub "WalterAPI: GetPrices - Get pricing data for a given stock over a timeframe (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.get_prices_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIGetNewsSummaryAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIGetNewsSummary
      FunctionVersion: 18
      Name: "release"

  WalterAPIGetNewsSummary:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-GetNewsSummary-${AppEnvironment}"
      Description: !Sub "WalterAPI: GetNewsSummary - Get AI summary of recent news for a given stock (${AppEnvironment})."
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.get_news_summary_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIGetPortfolioAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIGetPortfolio
      FunctionVersion: 42
      Name: "release"
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref WalterAPILambdaProvisionedConcurrencyCount

  WalterAPIGetPortfolio:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-GetPortfolio-${AppEnvironment}"
      Description: !Sub "WalterAPI: GetPortfolio - Get user portfolio from WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.get_portfolio_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPISendNewsletterAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPISendNewsletter
      FunctionVersion: 7
      Name: "release"

  WalterAPISendNewsletter:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-SendNewsletter-${AppEnvironment}"
      Description: !Sub "WalterAPI: SendNewsletter - generate and send a newsletter to the given user (${AppEnvironment})"
      Handler: walter.send_newsletter_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIGetNewsletterAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIGetNewsletter
      FunctionVersion: 6
      Name: "release"

  WalterAPIGetNewsletter:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-GetNewsletter-${AppEnvironment}"
      Description: !Sub "WalterAPI: GetNewsletter - Get user newsletter for given date from archive (${AppEnvironment})"
      Handler: walter.get_newsletter_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel


  WalterAPIGetNewslettersAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIGetNewsletters
      FunctionVersion: 13
      Name: "release"
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref WalterAPILambdaProvisionedConcurrencyCount

  WalterAPIGetNewsletters:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-GetNewsletters-${AppEnvironment}"
      Description: !Sub "WalterAPI: GetNewsletters - Get newsletters sent to user from archive (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.get_newsletters_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPISendVerifyEmailAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPISendVerifyEmail
      FunctionVersion: 4
      Name: "release"

  WalterAPISendVerifyEmail:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-SendVerifyEmail-${AppEnvironment}"
      Description: !Sub "WalterAPI: SendVerifyEmail- Generate and send a verification email to user (${AppEnvironment})"
      Handler: walter.send_verify_email_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIVerifyEmailAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIVerifyEmail
      FunctionVersion: 4
      Name: "release"

  WalterAPIVerifyEmail:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-VerifyEmail-${AppEnvironment}"
      Description: !Sub "WalterAPI: VerifyEmail- Verify a user ownership of an email address (${AppEnvironment})"
      Handler: walter.verify_email_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPISendChangePasswordEmailAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPISendChangePasswordEmail
      FunctionVersion: $LATEST
      Name: "release"

  WalterAPISendChangePasswordEmail:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-SendChangePasswordEmail-${AppEnvironment}"
      Description: !Sub "WalterAPI: SendChangePasswordEmail- Send change password link in email to user (${AppEnvironment})"
      Handler: walter.send_change_password_email_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIChangePasswordAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIChangePassword
      FunctionVersion: 4
      Name: "release"

  WalterAPIChangePassword:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-ChangePassword-${AppEnvironment}"
      Description: !Sub "WalterAPI: ChangePassword - Change the password of a user (${AppEnvironment})"
      Handler: walter.change_password_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIUpdatePasswordAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIUpdatePassword
      FunctionVersion: 1
      Name: "release"

  WalterAPIUpdatePassword:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-UpdatePassword-${AppEnvironment}"
      Description: !Sub "WalterAPI: UpdatePassword - Update user password given already authenticated session (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.update_password_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPISubscribeAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPISubscribe
      FunctionVersion: 4
      Name: "release"

  WalterAPISubscribe:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-Subscribe-${AppEnvironment}"
      Description: !Sub "WalterAPI: Subscribe - subscribe user to newsletter (${AppEnvironment})"
      Handler: walter.subscribe_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIUnsubscribeAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIUnsubscribe
      FunctionVersion: 4
      Name: "release"

  WalterAPIUnsubscribe:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-Unsubscribe-${AppEnvironment}"
      Description: !Sub "WalterAPI: Unsubscribe - unsubscribe user from newsletter (${AppEnvironment})"
      Handler: walter.unsubscribe_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPISearchStocksAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPISearchStocks
      FunctionVersion: 2
      Name: "release"

  WalterAPISearchStocks:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-SearchStocks-${AppEnvironment}"
      Description: !Sub "WalterAPI: SearchStocks - Search for a given stock and find the best matching results (${AppEnvironment})"
      Handler: walter.search_stocks_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIPurchaseNewsletterSubscriptionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIPurchaseNewsletterSubscription
      FunctionVersion: $LATEST
      Name: "release"

  WalterAPIPurchaseNewsletterSubscription:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-PurchaseNewsletterSubscription-${AppEnvironment}"
      Description: !Sub "WalterAPI: PurchaseNewsletterSubscription - Creates a checkout session for the user to purchase a newsletter subscription (${AppEnvironment})"
      Handler: walter.purchase_newsletter_subscription_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIVerifyPurchaseNewsletterSubscriptionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIVerifyPurchaseNewsletterSubscription
      FunctionVersion: $LATEST
      Name: "release"

  WalterAPIVerifyPurchaseNewsletterSubscription:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-VerifyPurchaseNewsletterSubscription-${AppEnvironment}"
      Description: !Sub "WalterAPI: VerifyPurchaseNewsletterSubscription - Verifies the payment status of a purchased newsletter subscription (${AppEnvironment})"
      Handler: walter.verify_purchase_newsletter_subscription_entrypoint
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: !Ref WalterAPITimeoutSeconds
      Runtime: python3.12
      SnapStart:
        ApplyOn: PublishedVersions
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIGetCashAccountsAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIGetCashAccounts
      FunctionVersion: 7
      Name: "release"

  WalterAPIGetCashAccounts:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-GetCashAccounts-${AppEnvironment}"
      Description: !Sub "WalterAPI: GetCashAccounts - Get cash accounts for user from WalterDB. (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.get_cash_accounts_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIUpdateCashAccountAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIUpdateCashAccount
      FunctionVersion: 5
      Name: "release"

  WalterAPIUpdateCashAccount:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-UpdateCashAccount-${AppEnvironment}"
      Description: !Sub "WalterAPI: UpdateCashAccount - Update cash account for a user in WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.update_cash_account_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIDeleteCashAccountAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIDeleteCashAccount
      FunctionVersion: 1
      Name: "release"

  WalterAPIDeleteCashAccount:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-DeleteCashAccount-${AppEnvironment}"
      Description: !Sub "WalterAPI: DeleteCashAccount - Delete cash account for user from WalterDB. (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.delete_cash_account_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPICreateCashAccountAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPICreateCashAccount
      FunctionVersion: 30
      Name: "release"

  WalterAPICreateCashAccount:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-CreateCashAccount-${AppEnvironment}"
      Description: !Sub "WalterAPI: CreateCashAccount - Create cash account for user in WalterDB. (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.create_cash_account_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIGetTransactionsAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIGetTransactions
      FunctionVersion: 16
      Name: "release"
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref WalterAPILambdaProvisionedConcurrencyCount

  WalterAPIGetTransactions:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-GetTransactions-${AppEnvironment}"
      Description: !Sub "WalterAPI: GetTransactions - Gets user transactions from WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.get_transactions_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIAddTransactionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIAddTransaction
      FunctionVersion: 37
      Name: "release"

  WalterAPIAddTransaction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-AddTransaction-${AppEnvironment}"
      Description: !Sub "WalterAPI: AddTransaction - Adds user transaction to WalterDB (${AppEnvironment})"
      Role: !GetAtt WalterAPIRole.Arn
      PackageType: Image
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.add_transaction_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIEditTransactionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIEditTransaction
      FunctionVersion: 37
      Name: "release"

  WalterAPIEditTransaction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-EditTransaction-${AppEnvironment}"
      Description: !Sub "WalterAPI: EditTransaction - Edit existing user transaction in WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.edit_transaction_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIDeleteTransactionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIDeleteTransaction
      FunctionVersion: 37
      Name: "release"

  WalterAPIDeleteTransaction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-DeleteTransaction-${AppEnvironment}"
      Description: !Sub "WalterAPI: DeleteTransaction - Delete user transaction from WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.delete_transaction_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPICreateLinkTokenAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPICreateLinkToken
      FunctionVersion: 16
      Name: "release"

  WalterAPICreateLinkToken:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-CreateLinkToken-${AppEnvironment}"
      Description: !Sub "WalterAPI: CreateLinkToken - Creates Plaid link token to generate user Plaid connection wizard (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.create_link_token_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPIExchangePublicTokenAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPIExchangePublicToken
      FunctionVersion: 15
      Name: "release"

  WalterAPIExchangePublicToken:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-ExchangePublicToken-${AppEnvironment}"
      Description: !Sub "WalterAPI: ExchangePublicToken - Exchanges Plaid item public token for user access token and saves in WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.exchange_public_token_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterAPISyncTransactionsAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterAPISyncTransactions
      FunctionVersion: 6
      Name: "release"

  WalterAPISyncTransactions:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterAPI-SyncTransactions-${AppEnvironment}"
      Description: !Sub "WalterAPI: SyncTransactions - The Plaid webhook API endpoint to sync transactions for the given user when updates are available (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Ref WalterAPIImageURI
      ImageConfig:
        Command:
          - walter.sync_transactions_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterCanaryAuthUserCanaryAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterCanaryAuthUserCanary
      FunctionVersion: $LATEST
      Name: !Sub "WalterCanary-AuthUserCanary-${AppEnvironment}"

  WalterCanaryAuthUserCanary:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterCanary-AuthUserCanary-${AppEnvironment}"
      Description: !Sub "WalterCanary: AuthUser - Call the AuthUser API with the canary account credentials to verify authentication (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.auth_user_canary_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterCanaryGetTransactionsAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterCanaryGetTransactions
      FunctionVersion: $LATEST
      Name: "release"

  WalterCanaryGetTransactions:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterCanary-GetTransactions-${AppEnvironment}"
      Description: !Sub "WalterCanary: GetTransactions - Call the GetTransactions API to ensure users are able to retrieve transactions from WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.get_transactions_canary_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterCanaryGetUserCanaryAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterCanaryGetUserCanary
      FunctionVersion: $LATEST
      Name: !Sub "WalterCanary-GetUserCanary-${AppEnvironment}"

  WalterCanaryGetUserCanary:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterCanary-GetUserCanary-${AppEnvironment}"
      Description: !Sub "WalterCanary: GetUser - Call the GetUser API with the canary account identity token and verify user identification (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.get_user_canary_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterCanaryGetStockCanaryAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterCanaryGetStockCanary
      FunctionVersion: $LATEST
      Name: !Sub "WalterCanary-GetStockCanary-${AppEnvironment}"

  WalterCanaryGetStockCanary:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterCanary-GetStockCanary-${AppEnvironment}"
      Description: !Sub "WalterCanary: GetStock - Call the GetStock API to get the stock information stored in WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.get_stock_canary_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterCanaryGetPortfolioCanaryAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterCanaryGetPortfolioCanary
      FunctionVersion: $LATEST
      Name: !Sub "WalterCanary-GetPortfolioCanary-${AppEnvironment}"

  WalterCanaryGetPortfolioCanary:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterCanary-GetPortfolioCanary-${AppEnvironment}"
      Description: !Sub "WalterCanary: GetPortfolio - Call the GetPortfolio API for the canary account to verify users can get their portfolio information (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.get_portfolio_canary_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterCanaryGetPricesCanaryAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterCanaryGetPricesCanary
      FunctionVersion: $LATEST
      Name: "release"

  WalterCanaryGetPricesCanary:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterCanary-GetPricesCanary-${AppEnvironment}"
      Description: !Sub "WalterCanary: GetPricesCanary - Call the GetPrices API to verify the ability to get the latest stock market pricing data (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.get_prices_canary_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterCanaryGetNewsSummaryCanaryAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterCanaryGetNewsSummaryCanary
      FunctionVersion: $LATEST
      Name: "release"

  WalterCanaryGetNewsSummaryCanary:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterCanary-GetNewsSummaryCanary-${AppEnvironment}"
      Description: !Sub "WalterCanary: GetNewsSummaryCanary - Call the GetNewsSummary API and get the latest stock market news summaries (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.get_news_summary_canary_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterCanaryGetNewslettersCanaryAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterCanaryGetNewslettersCanary
      FunctionVersion: $LATEST
      Name: "release"

  WalterCanaryGetNewslettersCanary:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterCanary-GetNewsletters-${AppEnvironment}"
      Description: !Sub "WalterCanary: GetNewsletters - Call the GetNewsletters API and get the latest newsletters for the user (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.get_newsletters_canary_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterCanarySearchStocksCanaryAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterCanarySearchStocksCanary
      FunctionVersion: $LATEST
      Name: "release"

  WalterCanarySearchStocksCanary:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterCanary-SearchStocksCanary-${AppEnvironment}"
      Description: !Sub "WalterCanary: SearchStocksCanary - Call the SearchStocks API to get stocks that are similar to the given identifier to verify user search functionality (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.search_stocks_canary_entrypoint
      Timeout: !Ref WalterAPITimeoutSeconds
      MemorySize: !Ref WalterAPILambdaMemorySizeMegabytes
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterWorkflowSyncUserTransactionsFunctionEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: 1
      EventSourceArn: !GetAtt SyncUserTransactionsQueue.Arn
      FunctionName: !GetAtt WalterWorkflowSyncUserTransactions.Arn
      Enabled: "True"

  WalterWorkflowSyncUserTransactionsAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterWorkflowSyncUserTransactions
      FunctionVersion: $LATEST
      Name: !Sub "WalterWorkflow-SyncUserTransactions-${AppEnvironment}"

  WalterWorkflowSyncUserTransactions:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterWorkflow-SyncUserTransactions-${AppEnvironment}"
      Description: !Sub "WalterWorkflow: SyncUserTransactions - Sync user transactions from Plaid to WalterDB (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterAPIRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.sync_user_transactions_entrypoint
      Timeout: 300
      MemorySize: 512
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel
      DeadLetterConfig:
        TargetArn: !GetAtt SyncUserTransactionsDeadLetterQueue.Arn
      Tags:
        - Key: "awsApplication"
          Value: "arn:aws:resource-groups:us-east-1:010526272437:group/Walter/06yzmmir0eiy0rnq10avqq9khd"

  WalterWorkflowAddNewsletterRequestsAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterWorkflowAddNewsletterRequests
      FunctionVersion: $LATEST
      Name: !Sub "WalterWorkflow-AddNewsletterRequests-${AppEnvironment}"

  WalterWorkflowAddNewsletterRequests:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterWorkflow-AddNewsletterRequests-${AppEnvironment}"
      Description: !Sub "WalterWorkflow: AddNewsletterRequests - Scan WalterDB and add newsletter requests for all users for asynchronous processing (${AppEnvironment})"
      Handler: walter.add_newsletter_requests_entrypoint
      Role: !GetAtt WalterNewslettersRole.Arn
      Code:
        S3Bucket: walter-backend-src
        S3Key: walter-backend.zip
      Timeout: 300
      Runtime: python3.12
      Architectures:
        - "arm64"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterWorkflowAddNewsSummaryRequestsAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterWorkflowAddNewsSummaryRequests
      FunctionVersion: $LATEST
      Name: "release"

  WalterWorkflowAddNewsSummaryRequests:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterWorkflow-AddNewsSummaryRequests-${AppEnvironment}"
      Description: !Sub "WalterWorkflow: AddNewsSummaryRequests - Scan WalterDB and add news summary requests for all stocks for asynchronous processing (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterWorkflowAddNewsSummaryRequestsRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.add_news_summary_requests_entrypoint
      Timeout: 60
      MemorySize: 512
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel

  WalterWorkflowCreateNewsSummaryAndArchiveAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterWorkflowCreateNewsSummaryAndArchive
      FunctionVersion: $LATEST
      Name: "release"

  WalterWorkflowCreateNewsSummaryAndArchive:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "WalterWorkflow-CreateNewsSummaryAndArchive-${AppEnvironment}"
      Description: !Sub "WalterWorkflow: CreateNewsSummaryAndArchive - Get recent stock news and generate AI summary to archive (${AppEnvironment})"
      PackageType: Image
      Role: !GetAtt WalterWorkflowCreateNewsSummaryAndArchiveRole.Arn
      Code:
        ImageUri: !Sub "${WalterAPIImageURI}"
      ImageConfig:
        Command:
          - walter.create_news_summary_and_archive_entrypoint
      Timeout: 300
      MemorySize: 512
      Architectures:
        - !Ref WalterAPILambdaArchitecture
      Environment:
        Variables:
          DOMAIN: DEVELOPMENT
          LOG_LEVEL: !Ref WalterAPILogLevel
      DeadLetterConfig:
        TargetArn: !GetAtt NewsSummariesDeadLetterQueue.Arn

  WalterWorkflowCreateNewsSummaryAndArchiveFunctionEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: 1
      EventSourceArn: !GetAtt NewsSummariesQueue.Arn
      FunctionName: !GetAtt WalterWorkflowCreateNewsSummaryAndArchive.Arn
      Enabled: "True"

  WalterWorkflowCreateNewsletterAndSendAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref WalterWorkflowCreateNewsletterAndSend
      FunctionVersion: $LATEST
      Name: !Sub "WalterWorkflow-CreateNewsletterAndSend-${AppEnvironment}"

  WalterWorkflowCreateNewsletterAndSend:
      Type: AWS::Lambda::Function
      Properties:
        FunctionName: !Sub "WalterWorkflow-CreateNewsletterAndSend-${AppEnvironment}"
        Description: !Sub "WalterWorkflow: CreateNewsletterAndSend - Get user portfolio from WalterDB and create newsletter and send (${AppEnvironment})"
        Handler: walter.create_newsletter_and_send_entrypoint
        Role: !GetAtt WalterBackendRole.Arn
        Code:
          S3Bucket: walter-backend-src
          S3Key: walter-backend.zip
        Timeout: 300
        Runtime: python3.12
        MemorySize: 512
        Architectures:
          - "arm64"
        Layers:
          - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:WalterBackendLambdaPythonDependencies:${WalterBackendLambdaLayerVersion}"
        Environment:
          Variables:
            DOMAIN: DEVELOPMENT
        DeadLetterConfig:
          TargetArn: !GetAtt NewslettersDeadLetterQueue.Arn
        Tags:
          - Key: "awsApplication"
            Value: "arn:aws:resource-groups:us-east-1:010526272437:group/Walter/06yzmmir0eiy0rnq10avqq9khd"

  WalterBackendFunctionEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: 1
      EventSourceArn: !GetAtt NewslettersQueue.Arn
      FunctionName: !GetAtt WalterWorkflowCreateNewsletterAndSend.Arn
      Enabled: "True"

  ################
  ### DYNAMODB ###
  ################

  TransactionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: date_uuid
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: date_uuid
          KeyType: RANGE
      TableName: !Sub "Transactions-${AppEnvironment}"

  CashAccountsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: account_id
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: account_id
          KeyType: RANGE
      TableName: !Sub "CashAccounts-${AppEnvironment}"

  CreditAccountsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: account_id
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: account_id
          KeyType: RANGE
      TableName: !Sub "CreditAccounts-${AppEnvironment}"

  StocksTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: symbol
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
          - AttributeName: symbol
            KeyType: HASH
      TableName: !Sub "Stocks-${AppEnvironment}"

  UsersStocksTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: stock_symbol
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
          - AttributeName: user_id
            KeyType: HASH
          - AttributeName: stock_symbol
            KeyType: RANGE
      TableName: !Sub "UsersStocks-${AppEnvironment}"

  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "Users-${AppEnvironment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: !Sub "Users-EmailIndex-${AppEnvironment}"
          KeySchema:
            - AttributeName: 'email'
              KeyType: 'HASH'
          Projection:
            ProjectionType: 'ALL'

  PlaidItemsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "PlaidItems-${AppEnvironment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: item_id
          AttributeType: S
        - AttributeName: institution_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: item_id
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: !Sub "PlaidItems-UserInstitutionIndex-${AppEnvironment}"
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: institution_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: !Sub "PlaidItems-ItemIdIndex-${AppEnvironment}"
          KeySchema:
            - AttributeName: item_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  #################
  ### IAM ROLES ###
  #################

  WalterAPIRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "WalterAPIRole-${AppEnvironment}"
      Description: "WalterAPI execution role to read and modify WalterDB and send newsletters (${AppEnvironment})"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service:
                - "lambda.amazonaws.com"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  WalterNewslettersRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "WalterNewslettersRole-${AppEnvironment}"
      Description: "WalterNewsletters role to send newsletter requests to the queue (${AppEnvironment})"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service:
                - "lambda.amazonaws.com"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  WalterWorkflowAddNewsSummaryRequestsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "WalterWorkflow-AddNewsSummaryRequestsRole-${AppEnvironment}"
      Description: !Sub "WalterWorkflow-AddNewsSummaryRequests-${AppEnvironment} role to add news summary requests to queue for asynchronous processing."
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service:
                - "lambda.amazonaws.com"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  WalterWorkflowCreateNewsSummaryAndArchiveRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "WalterWorkflow-CreateNewsSummaryAndArchiveRole-${AppEnvironment}"
      Description: !Sub "WalterWorkflow-CreateNewsSummaryAndArchive role to create news summaries and archive in S3 (${AppEnvironment})"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service:
                - "lambda.amazonaws.com"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  WalterBackendRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "WalterBackendRole-${AppEnvironment}"
      Description: "WalterBackend execution role write and send newsletters (${AppEnvironment})"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service:
                - "lambda.amazonaws.com"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  ####################
  ### IAM POLICIES ###
  ####################

  BedrockAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "BedrockAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "bedrock:InvokeModel"
            Resource:
              - "arn:aws:bedrock:us-east-1::foundation-model/amazon.nova-micro-v1:0"
              - "arn:aws:bedrock:us-east-1::foundation-model/amazon.nova-lite-v1:0"
              - "arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-3-5-haiku-20241022-v1:0"
              - "arn:aws:bedrock:us-east-1:010526272437:inference-profile/us.anthropic.claude-3-5-sonnet-20241022-v2:0"
              - "arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0"
              - "arn:aws:bedrock:us-east-2::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0"
              - "arn:aws:bedrock:us-west-2::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0"
              - "arn:aws:bedrock:us-east-1:010526272437:inference-profile/us.meta.llama3-3-70b-instruct-v1:0"
              - "arn:aws:bedrock:us-east-1::foundation-model/meta.llama3-3-70b-instruct-v1:0"
              - "arn:aws:bedrock:us-east-2::foundation-model/meta.llama3-3-70b-instruct-v1:0"
              - "arn:aws:bedrock:us-west-2::foundation-model/meta.llama3-3-70b-instruct-v1:0"
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterBackendRole
        - !Ref WalterWorkflowCreateNewsSummaryAndArchiveRole

  CloudWatchAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "CloudWatchAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "cloudwatch:PutMetricData"
            Resource: "*"
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterBackendRole
        - !Ref WalterNewslettersRole
        - !Ref WalterWorkflowAddNewsSummaryRequestsRole
        - !Ref WalterWorkflowCreateNewsSummaryAndArchiveRole

  NewslettersBucketAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "NewslettersBucketAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "s3:GetObject"
              - "s3:PutObject"
            Resource: !Sub "${NewslettersBucket.Arn}/*"
          - Effect: Allow
            Action:
              - "s3:List*"
            Resource: !GetAtt NewslettersBucket.Arn
      Roles:
        - !Ref WalterBackendRole
        - !Ref WalterAPIRole

  NewslettersQueueAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "NewslettersQueueAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "sqs:ReceiveMessage"
              - "sqs:DeleteMessage"
              - "sqs:GetQueueAttributes"
              - "sqs:SendMessage"
            Resource: !GetAtt NewslettersQueue.Arn
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterNewslettersRole
        - !Ref WalterBackendRole

  SyncUserTransactionsQueueAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "SyncUserTransactionsQueueAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "sqs:ReceiveMessage"
              - "sqs:DeleteMessage"
              - "sqs:GetQueueAttributes"
              - "sqs:SendMessage"
            Resource: !GetAtt SyncUserTransactionsQueue.Arn
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterNewslettersRole
        - !Ref WalterBackendRole

  SyncUserTransactionsDeadLetterQueueAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "SyncUserTransactionsDeadLetterQueueAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "sqs:ReceiveMessage"
              - "sqs:DeleteMessage"
              - "sqs:GetQueueAttributes"
              - "sqs:SendMessage"
            Resource: !GetAtt SyncUserTransactionsDeadLetterQueue.Arn
      Roles:
        - !Ref WalterBackendRole
        - !Ref WalterAPIRole

  NewslettersDeadLetterQueueAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "NewslettersDeadLetterQueueAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "sqs:ReceiveMessage"
              - "sqs:DeleteMessage"
              - "sqs:GetQueueAttributes"
              - "sqs:SendMessage"
            Resource: !GetAtt NewslettersDeadLetterQueue.Arn
      Roles:
        - !Ref WalterBackendRole

  NewsSummariesQueueAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "NewsSummariesQueueAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "sqs:ReceiveMessage"
              - "sqs:DeleteMessage"
              - "sqs:GetQueueAttributes"
              - "sqs:SendMessage"
            Resource: !GetAtt NewsSummariesQueue.Arn
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterWorkflowAddNewsSummaryRequestsRole
        - !Ref WalterBackendRole
        - !Ref WalterWorkflowCreateNewsSummaryAndArchiveRole

  NewsSummariesDeadLetterQueueAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "NewsSummariesDeadLetterQueueAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "sqs:ReceiveMessage"
              - "sqs:DeleteMessage"
              - "sqs:GetQueueAttributes"
              - "sqs:SendMessage"
            Resource: !GetAtt NewsSummariesDeadLetterQueue.Arn
      Roles:
        - !Ref WalterWorkflowCreateNewsSummaryAndArchiveRole

  SecretsManagerAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "SecretsManagerAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "secretsmanager:GetSecretValue"
            Resource: !Join
              - ""
              - - "arn:aws:secretsmanager:"
                - !Ref "AWS::Region"
                - ":"
                - !Ref "AWS::AccountId"
                - ":secret:AlphaVantageAPIKey-F7qJAw"
          - Effect: Allow
            Action:
              - "secretsmanager:GetSecretValue"
            Resource: !Join
              - ""
              - - "arn:aws:secretsmanager:"
                - !Ref "AWS::Region"
                - ":"
                - !Ref "AWS::AccountId"
                - ":secret:AlphaVantagePremiumAPIKey-xB99wz"
          - Effect: Allow
            Action:
              - "secretsmanager:GetSecretValue"
            Resource: !Join
              - ""
              - - "arn:aws:secretsmanager:"
                - !Ref "AWS::Region"
                - ":"
                - !Ref "AWS::AccountId"
                - ":secret:PolygonAPIKey-vZymuJ"
          - Effect: Allow
            Action:
              - "secretsmanager:GetSecretValue"
            Resource: !Join
              - ""
              - - "arn:aws:secretsmanager:"
                - !Ref "AWS::Region"
                - ":"
                - !Ref "AWS::AccountId"
                - ":secret:JWTSecretKey-E5va6r"
          - Effect: Allow
            Action:
              - "secretsmanager:GetSecretValue"
            Resource: !Join
              - ""
              - - "arn:aws:secretsmanager:"
                - !Ref "AWS::Region"
                - ":"
                - !Ref "AWS::AccountId"
                - ":secret:JWTVerifyEmailSecretAccessKey-9KhIYG"
          - Effect: Allow
            Action:
              - "secretsmanager:GetSecretValue"
            Resource: !Join
              - ""
              - - "arn:aws:secretsmanager:"
                - !Ref "AWS::Region"
                - ":"
                - !Ref "AWS::AccountId"
                - ":secret:JWTChangePasswordSecretKey-f0RsUz"
          - Effect: Allow
            Action:
              - "secretsmanager:GetSecretValue"
            Resource: !Join
              - ""
              - - "arn:aws:secretsmanager:"
                - !Ref "AWS::Region"
                - ":"
                - !Ref "AWS::AccountId"
                - ":secret:StockNewsAPIKey-elCcnH"
          - Effect: Allow
            Action:
              - "secretsmanager:GetSecretValue"
            Resource: !Join
              - ""
              - - "arn:aws:secretsmanager:"
                - !Ref "AWS::Region"
                - ":"
                - !Ref "AWS::AccountId"
                - ":secret:StripeTestSecretKey-8vIZfy"
          - Effect: Allow
            Action:
              - "secretsmanager:GetSecretValue"
            Resource: !Join
              - ""
              - - "arn:aws:secretsmanager:"
                - !Ref "AWS::Region"
                - ":"
                - !Ref "AWS::AccountId"
                - ":secret:PlaidSandboxCredentials-GtcPUQ"
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterNewslettersRole
        - !Ref WalterBackendRole
        - !Ref WalterWorkflowAddNewsSummaryRequestsRole
        - !Ref WalterWorkflowCreateNewsSummaryAndArchiveRole

  SimpleEmailSerivceAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "SimpleEmailServiceAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "ses:Send*"
            Resource: "*"
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterBackendRole

  StocksTableAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "StocksTableAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "dynamodb:BatchGet*"
              - "dynamodb:Get*"
              - "dynamodb:Query"
              - "dynamodb:Scan"
              - "dynamodb:BatchWrite*"
              - "dynamodb:Delete*"
              - "dynamodb:Update*"
              - "dynamodb:PutItem"
            Resource: !GetAtt StocksTable.Arn
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterBackendRole
        - !Ref WalterWorkflowAddNewsSummaryRequestsRole
        - !Ref WalterWorkflowCreateNewsSummaryAndArchiveRole

  TemplatesBucketAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "TemplatesBucketAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "s3:GetObject"
            Resource: !Sub "${TemplatesBucket.Arn}/*"
          - Effect: Allow
            Action:
              - "s3:List*"
            Resource: !GetAtt TemplatesBucket.Arn
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterBackendRole

  TransactionsTableAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "TransactionsTableAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "dynamodb:BatchGet*"
              - "dynamodb:Get*"
              - "dynamodb:Query"
              - "dynamodb:Scan"
              - "dynamodb:BatchWrite*"
              - "dynamodb:Delete*"
              - "dynamodb:Update*"
              - "dynamodb:PutItem"
            Resource: !GetAtt TransactionsTable.Arn
      Roles:
        - !Ref WalterAPIRole

  CashAccountsTableAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "CashAccountsTableAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "dynamodb:BatchGet*"
              - "dynamodb:Get*"
              - "dynamodb:Query"
              - "dynamodb:Scan"
              - "dynamodb:BatchWrite*"
              - "dynamodb:Delete*"
              - "dynamodb:Update*"
              - "dynamodb:PutItem"
            Resource: !GetAtt CashAccountsTable.Arn
      Roles:
        - !Ref WalterAPIRole

  CreditAccountsTableAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "CreditAccountsTableAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "dynamodb:BatchGet*"
              - "dynamodb:Get*"
              - "dynamodb:Query"
              - "dynamodb:Scan"
              - "dynamodb:BatchWrite*"
              - "dynamodb:Delete*"
              - "dynamodb:Update*"
              - "dynamodb:PutItem"
            Resource: !GetAtt CreditAccountsTable.Arn
      Roles:
        - !Ref WalterAPIRole

  UsersStocksTableAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "UsersStocksTableAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "dynamodb:BatchGet*"
              - "dynamodb:Get*"
              - "dynamodb:Query"
              - "dynamodb:Scan"
              - "dynamodb:BatchWrite*"
              - "dynamodb:Delete*"
              - "dynamodb:Update*"
              - "dynamodb:PutItem"
            Resource: !GetAtt UsersStocksTable.Arn
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterBackendRole

  UsersTableAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "UsersTableAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "dynamodb:BatchGet*"
              - "dynamodb:Get*"
              - "dynamodb:Query"
              - "dynamodb:Scan"
              - "dynamodb:BatchWrite*"
              - "dynamodb:Delete*"
              - "dynamodb:Update*"
              - "dynamodb:PutItem"
            Resource: !GetAtt UsersTable.Arn
          - Effect: Allow
            Action:
              - "dynamodb:Query"
            Resource:
              - !Join
                - ""
                - - "arn:aws:dynamodb:"
                  - !Ref "AWS::Region"
                  - ":"
                  - !Ref "AWS::AccountId"
                  - ":table/"
                  - !Sub "Users-${AppEnvironment}"
                  - "/index/"
                  - !Sub "Users-EmailIndex-${AppEnvironment}"
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterNewslettersRole
        - !Ref WalterBackendRole

  PlaidItemsTableAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "PlaidItemsTableAccessPolicy-${AppEnvironment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "dynamodb:BatchGet*"
              - "dynamodb:Get*"
              - "dynamodb:Query"
              - "dynamodb:Scan"
              - "dynamodb:BatchWrite*"
              - "dynamodb:Delete*"
              - "dynamodb:Update*"
              - "dynamodb:PutItem"
            Resource: !GetAtt PlaidItemsTable.Arn
          - Effect: Allow
            Action:
              - "dynamodb:Query"
            Resource:
              - !Join
                - ""
                - - "arn:aws:dynamodb:"
                  - !Ref "AWS::Region"
                  - ":"
                  - !Ref "AWS::AccountId"
                  - ":table/"
                  - !Sub "PlaidItems-${AppEnvironment}"
                  - "/index/"
                  - !Sub "PlaidItems-UserInstitutionIndex-${AppEnvironment}"
          - Effect: Allow
            Action:
              - "dynamodb:Query"
            Resource:
              - !Join
                - ""
                - - "arn:aws:dynamodb:"
                  - !Ref "AWS::Region"
                  - ":"
                  - !Ref "AWS::AccountId"
                  - ":table/"
                  - !Sub "PlaidItems-${AppEnvironment}"
                  - "/index/"
                  - !Sub "PlaidItems-ItemIdIndex-${AppEnvironment}"
      Roles:
        - !Ref WalterAPIRole
        - !Ref WalterBackendRole
        - !Ref WalterWorkflowAddNewsSummaryRequestsRole
        - !Ref WalterWorkflowCreateNewsSummaryAndArchiveRole

  ##########
  ### S3 ###
  ##########

  MediaBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub "walterai-media-${AppEnvironment}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      VersioningConfiguration:
        Status: Enabled

  MediaBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref MediaBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - "s3:GetObject"
              - "s3:PutObject"
            Effect: Allow
            Resource: !Sub "${MediaBucket.Arn}/*"
            Principal:
              AWS:
                - !GetAtt WalterAPIRole.Arn
          - Action:
              - "s3:ListBucket"
            Effect: Allow
            Resource: !GetAtt MediaBucket.Arn
            Principal:
              AWS:
                - !GetAtt WalterAPIRole.Arn

  NewslettersBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub "walterai-newsletters-${AppEnvironment}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: "DeleteOldNewsletters"
            Status: "Enabled"
            ExpirationInDays: 30

  NewslettersBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref NewslettersBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - "s3:PutObject"
            Effect: Allow
            Resource: !Sub "${NewslettersBucket.Arn}/*"
            Principal:
              AWS: !GetAtt WalterBackendRole.Arn

  NewsSummariesBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub "walterai-news-summaries-${AppEnvironment}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: "DeleteOldNewsSummaries"
            Status: "Enabled"
            ExpirationInDays: 30

  NewsSummariesBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref NewsSummariesBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - "s3:GetObject"
              - "s3:PutObject"
            Effect: Allow
            Resource: !Sub "${NewsSummariesBucket.Arn}/*"
            Principal:
              AWS:
                - !GetAtt WalterAPIRole.Arn
                - !GetAtt WalterBackendRole.Arn
                - !GetAtt WalterWorkflowCreateNewsSummaryAndArchiveRole.Arn
          - Action:
              - "s3:ListBucket"
            Effect: Allow
            Resource: !Sub "${NewsSummariesBucket.Arn}"
            Principal:
              AWS:
                - !GetAtt WalterAPIRole.Arn
                - !GetAtt WalterBackendRole.Arn
                - !GetAtt WalterWorkflowCreateNewsSummaryAndArchiveRole.Arn

  TemplatesBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub "walterai-templates-${AppEnvironment}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      VersioningConfiguration:
        Status: Enabled

  TemplatesBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref TemplatesBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - "s3:GetObject"
            Effect: Allow
            Resource: !Sub "${TemplatesBucket.Arn}/*"
            Principal:
              AWS: !GetAtt WalterBackendRole.Arn
          - Action:
              - "s3:List*"
            Effect: Allow
            Resource: !GetAtt TemplatesBucket.Arn
            Principal:
              AWS: !GetAtt WalterBackendRole.Arn

  ###########
  ### SQS ###
  ###########

  SyncUserTransactionsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "SyncUserTransactionsQueue-${AppEnvironment}"
      SqsManagedSseEnabled: true
      VisibilityTimeout: 360
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt SyncUserTransactionsDeadLetterQueue.Arn
        maxReceiveCount: 1

  SyncUserTransactionsDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "SyncUserTransactionsDeadletterQueue-${AppEnvironment}"
      SqsManagedSseEnabled: true
      VisibilityTimeout: 90
      MessageRetentionPeriod: 1209600 # two weeks

  NewslettersQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "NewslettersQueue-${AppEnvironment}"
      SqsManagedSseEnabled: true
      VisibilityTimeout: 360
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt NewslettersDeadLetterQueue.Arn
        maxReceiveCount: 1

  NewslettersDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "NewslettersDeadLetterQueue-${AppEnvironment}"
      SqsManagedSseEnabled: true
      VisibilityTimeout: 90
      MessageRetentionPeriod: 1209600 # two weeks

  NewsSummariesQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "NewsSummariesQueue-${AppEnvironment}"
      SqsManagedSseEnabled: true
      VisibilityTimeout: 360
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt NewsSummariesDeadLetterQueue.Arn
        maxReceiveCount: 1

  NewsSummariesDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "NewsSummariesDeadLetterQueue-${AppEnvironment}"
      SqsManagedSseEnabled: true
      VisibilityTimeout: 90
      MessageRetentionPeriod: 1209600 # two weeks

###############
### OUTPUTS ###
###############

Outputs:
  WalterAPIAuthUserEndpoint:
    Value: !Sub "https://${WalterAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${AppEnvironment}/auth"
  WalterAPICreateUserEndpoint:
    Value: !Sub "https://${WalterAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${AppEnvironment}/users"
  WalterAPIAddStockEndpoint:
    Value: !Sub "https://${WalterAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${AppEnvironment}/stocks"
  WalterAPIDeleteStockEndpoint:
    Value: !Sub "https://${WalterAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${AppEnvironment}/stocks"
  WalterAPIGetPortfolioEndpoint:
    Value: !Sub "https://${WalterAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${AppEnvironment}/portfolios"
  WalterAPIGetPricesEndpoint:
    Value: !Sub "https://${WalterAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${AppEnvironment}/prices"
  WalterAPIGetNewsSummaryEndpoint:
    Value: !Sub "https://${WalterAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${AppEnvironment}/news"
  WalterAPISendNewsletterEndpoint:
    Value: !Sub "https://${WalterAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${AppEnvironment}/newsletters"
  WalterAPISubscribeEndpoint:
    Value: !Sub "https://${WalterAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${AppEnvironment}/subscribe"
  WalterAPIUnsubscribeEndpoint:
    Value: !Sub "https://${WalterAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${AppEnvironment}/unsubscribe"